---
apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: resource-provisioner
  title: Resource Provisioner
  description: Complete the form to request a resource provisioning. Once submitted, a Pull Request will be created for the Platform Engineering Team to complete the request.
  tags:
    - provisioner
spec:
  owner: PHAC
  type: Service
  parameters:
    - title: Project
      required:
        - folderName
        - projectName
        - displayName
      properties:
        folderName:
          title: Folder Name
          type: string
          default: ph-
          ui:description: This will create a folder in HC-DMIA > DMIA-PHAC > SciencePlatform
        projectName:
          title: Project Name
          type: string
          default: phx-project
          ui:description: Project names begin with a 3-letter prefix. Use the prefix 'phx' for Experiments, 'phd' for Dev, 'pht' for Test, and 'php' for Prod. Give the project a name for how it is used not who creates it.
        displayName:
          title: Display Name
          type: string
          description: The human-readable name of the GCP Project used for display purposes.
          default: Project ABC
    - title: Administrative Data
      required:
        - costCentre
        - section32ManagerEmail
        - justificationNote
      properties:
        costCentre:
          title: Cost Centre
          type: string
        section32ManagerEmail:
          title: Section 32 Manager Email Address
          type: string
          format: email
        justificationNote:
          title: Justification Note
          type: string
          ui:widget: textarea
          ui:options:
            rows: 5
        serviceOwners:
          title: Service Owners
          type: string
          ui:widget: textarea
          ui:description: The `@gcp.hc-sc.gc.ca` email addresses of users who should own this service, separated by comma.
          ui:options:
            rows: 8
          ui:placeholder: jane.doe@gcp.hc-sc.gc.ca, john.doe@gcp.hc-sc.gc.ca, steve.smith@gcp.hc-sc.gc.ca
    - title: Billing Details
      required:
        - totalBudget
      properties:
        totalBudget:
          title: Total Budget Amount (CAD)
          type: number
          minimum: 0,
        notifyList:
          title: Notify List
          type: string
          ui:widget: textarea
          ui:description: The `@phac-aspc.gc.ca` email addresses of users who should be notified of budget alerts, separated by a comma.
          ui:options:
            rows: 8
          ui:placeholder: jane.doe@phac-aspc.gc.ca, john.doe@phac-aspc.gc.ca, steve.smith@phac-aspc.gc.ca
    - title: Pull Request
      backstage:featureFlag: template-developer
      properties:
        closePullRequest:
          title: Close Pull Request?
          type: boolean
          default: true
          ui:widget: radio
          ui:description: Add the `[Test] ` prefix to close the pull request.
  steps:
    - id: create_resource
      name: Processing Request
      action: phac:provisioner:create
      input:
        projectName: ${{ parameters.projectName }}
        displayName: ${{ parameters.displayName }}
        folderName: ${{ parameters.folderName }}
        costCentre: ${{ parameters.costCentre }}
        section32ManagerEmail: ${{ parameters.section32ManagerEmail }}
        justificationNote: ${{ parameters.justificationNote }}
        serviceOwners: ${{ parameters.serviceOwners }}

    - id: publish
      name: Submitting Request
      action: publish:github:pull-request
      input:
        repoUrl: github.com?owner=${{ steps.create_resource.output.repo_owner }}&repo=${{ steps.create_resource.output.repo_name }}
        title: ${{ "[Test] " if parameters.closePullRequest else '' }}Create ${{steps.create_resource.output.resource_type}}
        branchName: request-${{steps.create_resource.output.request_id}}
        description: |
          # Create ${{steps.create_resource.output.resource_type}}

          This PR was created using Backstage. The request ID is `${{steps.create_resource.output.request_id}}`.

          <!-- ### Client Name Email address -->

          ### Administrative Details

          **Cost Centre:** ${{parameters.costCentre}}
          **Justification:** ${{parameters.justificationNote}}
          **Section 32 Manager Email:** ${{parameters.section32ManagerEmail}}
          **Service Owners:** ${{parameters.serviceOwners}}

          ### GCP Project

          **Folder Name:** ${{parameters.folderName}}
          **Project Name:** ${{parameters.projectName}}
          **Display Name:** ${{parameters.displayName}}

        targetPath: ./DMIA-PHAC/SciencePlatform/${{parameters.folderName}}

  output:
    links:
      - url: ${{steps.publish.output.remoteUrl}}
        title: 'View PR'
